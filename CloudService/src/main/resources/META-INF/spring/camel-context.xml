<?xml version="1.0" encoding="UTF-8"?>
<!-- Configures the Camel Context-->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">

	<!--Helper Bean to extract data from MQTT Topic and and to Message in csv values  -->
  	<bean id="myHelper" class="com.redhat.demo.iotdemo.cloudService.EurotechTransformer" />
    
  	<!--Connection to activeMQ Broker running on same system  -->
  	<bean id="activemqGateway" class="org.apache.activemq.camel.component.ActiveMQComponent" >
    	<property name="connectionFactory">
      		<bean class="org.apache.activemq.ActiveMQConnectionFactory">
        		<property name="brokerURL" value="${SOURCE_AMQ_BROKER}" />
        		<property name="userName" value="${SOURCE_BROKER_ADMIN_UID}"/>
        		<property name="password" value="${SOURCE_BROKER_ADMIN_PASSWD}"/>
      		</bean>
    	</property>
  	</bean>

  	<!--Initiate access to properties -->
  	<bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"/>

 	<!-- Route from local MQTT-Broker to local JMS Broker -->
	<camelContext xmlns="http://camel.apache.org/schema/spring">
		<propertyPlaceholder location="classpath:org/apache/camel/component/properties/myprop.properties" id="properties"/>
		<dataFormats><!--Marshals KuraPayload Pojo with Gson annotations into a json string for posting-->
			<json id="kurapayloadtojson" library="Gson" unmarshalTypeName="com.redhat.demo.iotdemo.cloudService.kura.KuraPayload"/>
		</dataFormats>
		<route id="messagesFromCEP">
			<from uri="activemqGateway:queue:message.to.datacenter"/>
			<setHeader headerName="Content-Type">
				<constant>application/json</constant>
			</setHeader>
			<bean ref="myHelper" method="transform" beanType="com.redhat.demo.cloudService.EurotechTransformer"/><!--Convert from internal model to Kura/EC payload model-->
			<marshal ref="kurapayloadtojson"/><!--And Marshal that out to json for the http post-->
			<to uri="https4://api-sandbox.everyware-cloud.com/v2/messages/publish?authUsername=p-steiner&amp;authPassword=p-steinerC!oud16&amp;authenticationPreemptive=true"/>
		</route>
	</camelContext>

</beans>
